# SharedDeposit

Contracts powering https://sharedstake.org / https://sharedstake.finance

Ethereum liquid staking derivatives.  
Docs: https://docs.sharedstake.finance/

V2 core auditable contracts and guidance/README in `contracts/v2/core`.

# Deployed mainnet contracts

## Aug 31 '21

NFT
MintableNFTSale deployed to 0x926a65012C23dcfB2227af46e6135C1c6413D8Ac at https://etherscan.io/address/0x926a65012C23dcfB2227af46e6135C1c6413D8Ac
cost: 322125589811035895 or 0.322 ETH

founderVesting deployed to 0x0279eBC54179EBc5E5e65A9f036Db351233adDc6 at https://etherscan.io/address/0x0279eBC54179EBc5E5e65A9f036Db351233adDc6  
treasuryVesting deployed to 0x2Cb4bdc030975f2ABdbbb984e87715505C51D5BC at https://etherscan.io/address/0x2Cb4bdc030975f2ABdbbb984e87715505C51D5BC  
SGTv2 deployed to 0x24C19F7101c1731b85F1127EaA0407732E36EcDD at https://etherscan.io/address/0x24C19F7101c1731b85F1127EaA0407732E36EcDD

TokenMigrator deployed to 0x9615460582Efa2a9b1d8D21e7E02afE43A415E13 at https://etherscan.io/address/0x9615460582Efa2a9b1d8D21e7E02afE43A415E13  
VoteEscrowFactory deployed to 0xeE5bd4b9C875BE3958b1255D181B8B3E978903b9 at https://etherscan.io/address/0xeE5bd4b9C875BE3958b1255D181B8B3E978903b9  
SimpleTimelock deployed to 0xC0AAB794F9D2aA7cE56B8BEB6cFfc71BC05c21FC at https://etherscan.io/address/0xC0AAB794F9D2aA7cE56B8BEB6cFfc71BC05c21FC  
FundDistributor deployed to 0x38aa4CC003D9Ad84505bc7b096122402Db31f708 at https://etherscan.io/address/0x38aa4CC003D9Ad84505bc7b096122402Db31f708  
MasterChef deployed to 0x84B7644095d9a8BFDD2e5bfD8e41740bc1f4f412 at https://etherscan.io/address/0x84B7644095d9a8BFDD2e5bfD8e41740bc1f4f412

VeSGT : 0x21b555305e9d65c8b8ae232e60fd806edc9c5d78 : https://etherscan.io/address/0x21b555305e9d65c8b8ae232e60fd806edc9c5d78#code

# Goerli

## Fri jul 7 23

SharedDepositMinterV2 deployed to 0x1C974Ef3993152eCB53FdCF8b543b39f82122447 at https://goerli.etherscan.io/address/0x1C974Ef3993152eCB53FdCF8b543b39f82122447

PaymentSplitter deployed to 0xa609E0Dd2475739ac705fc17f38D9F5584c2c28D at https://goerli.etherscan.io/address/0xa609E0Dd2475739ac705fc17f38D9F5584c2c28D

Withdrawals deployed to 0x807EB95706E365115adAbeb4884c1Eb39D062A6d at https://goerli.etherscan.io/address/0x807EB95706E365115adAbeb4884c1Eb39D062A6d

RewardsReceiver deployed to 0x67c2F94F308F7fe6Dd1bf1bD7BF55715E1b1579b at https://goerli.etherscan.io/address/0x67c2F94F308F7fe6Dd1bf1bD7BF55715E1b1579b

## Wed jul 6 '23

SharedDepositMinterV2 deployed to 0x711c07cbfb82d5cB6Eb665350237C25c302f4A13 at https://goerli.etherscan.io/address/0x711c07cbfb82d5cB6Eb665350237C25c302f4A13

PaymentSplitter deployed to 0xA64629072cb064B2F3084Ca4C2D9d1e2F5c1fe02 at https://goerli.etherscan.io/address/0xA64629072cb064B2F3084Ca4C2D9d1e2F5c1fe02

Withdrawals deployed to 0x01cF4caDca14a9988F9116d7701494e58E567528 at https://goerli.etherscan.io/address/0x01cF4caDca14a9988F9116d7701494e58E567528

YieldDirector deployed to 0xc539a20b49DDe9a0E86b3FF5e00CCD5519001114 at https://goerli.etherscan.io/address/0xc539a20b49DDe9a0E86b3FF5e00CCD5519001114

RewardsReceiver deployed to 0x3048D0A5813dFcB7aD4Dbb2f747E993aF8b70E8a at https://goerli.etherscan.io/address/0x3048D0A5813dFcB7aD4Dbb2f747E993aF8b70E8a

## Wed jul 5 '23

SharedDepositMinterV2 deployed to 0x5d03e8d58A58244DB0ad5D4CEc7DC7737F2F37a3 at https://goerli.etherscan.io/address/0x5d03e8d58A58244DB0ad5D4CEc7DC7737F2F37a3

## Sun jul 2 '23

SharedDepositMinterV2 deployed to 0x5464Eb94ECf019d5b05099A89dB302cF7ac3e863 at https://goerli.etherscan.io/address/0x5464Eb94ECf019d5b05099A89dB302cF7ac3e863

## Wed Jun 14 '23

SgETH deployed to 0x453B459249F82ba3f369651aD485Fa11C6F082F8 at https://goerli.etherscan.io/address/0x453B459249F82ba3f369651aD485Fa11C6F082F8
WSGETH deployed to 0xbFA813C3266Af70A5Ddc15d9253655281e2bCd23 at https://goerli.etherscan.io/address/0xbFA813C3266Af70A5Ddc15d9253655281e2bCd23
SharedDepositMinter deployed to 0xb5ae9d51858436c23dca94370a38ff495a54873b at https://goerli.etherscan.io/address/0xb5ae9d51858436c23dca94370a38ff495a54873b
PaymentSplitter deployed to 0xC01063EC89B210BE8037d549D618980845657994 at https://goerli.etherscan.io/address/0xC01063EC89B210BE8037d549D618980845657994
Withdrawals deployed to 0x765d0dA8536cE858E0D2B54025b223231db0FeAE at https://goerli.etherscan.io/address/0x765d0dA8536cE858E0D2B54025b223231db0FeAE
ETH2SgETHYieldRedirector deployed to 0x8253F05c5E7b76F5ff855a6D52Ea9B9B5FD666cA at https://goerli.etherscan.io/address/0x8253F05c5E7b76F5ff855a6D52Ea9B9B5FD666cA
RewardsReceiver deployed to 0xC9F2ddBf105ff67c2BA30b2dB968Bc564a16ca67 at https://goerli.etherscan.io/address/0xC9F2ddBf105ff67c2BA30b2dB968Bc564a16ca67
WithdrawalsvETH2 deployed to 0xd70201Ea40c12cFE6Bf69Dc9A2ca9FB14bb8DB0b at https://goerli.etherscan.io/address/0xd70201Ea40c12cFE6Bf69Dc9A2ca9FB14bb8DB0b
Rollover deployed to 0xaa93EF92Ef8663902BeE679B9B8bFB60c966d50C at https://goerli.etherscan.io/address/0xaa93EF92Ef8663902BeE679B9B8bFB60c966d50C

## Wed Jun 7 '23

SgETH deployed to 0xd0f593aeB7E22B1038edC398aA53A56B38435de9 at https://goerli.etherscan.io/address/0xd0f593aeB7E22B1038edC398aA53A56B38435de9
WSGETH deployed to 0xCE066A0C47b95aA7fF53A22D099A1F33F3d7e7D9 at https://goerli.etherscan.io/address/0xCE066A0C47b95aA7fF53A22D099A1F33F3d7e7D9
SharedDepositMinter deployed to 0x62a4f18E1c42c63c6D02668A714eaD7323eF5CE0 at https://goerli.etherscan.io/address/0x62a4f18E1c42c63c6D02668A714eaD7323eF5CE0
PaymentSplitter deployed to 0xBaB96eEEE86b3dc57378C2b95aaFEc0aD3cc1Ed5 at https://goerli.etherscan.io/address/0xBaB96eEEE86b3dc57378C2b95aaFEc0aD3cc1Ed5
Withdrawals deployed to 0x62C4df1d2D30509833dEac78E968762Bf1B0CB6d at https://goerli.etherscan.io/address/0x62C4df1d2D30509833dEac78E968762Bf1B0CB6d
ETH2SgETHYieldRedirector deployed to 0xd810D44Ad63582C457814eD3a47e1d9B83aC2358 at https://goerli.etherscan.io/address/0xd810D44Ad63582C457814eD3a47e1d9B83aC2358
RewardsReceiver deployed to 0xf38bA1f9B416Ce6eB3D9336f417a5Fbf88aEb84F at https://goerli.etherscan.io/address/0xf38bA1f9B416Ce6eB3D9336f417a5Fbf88aEb84F
WithdrawalsvETH2 deployed to 0x0f779f0c7d0c8b9cD6e23e62D9aE51ED39aa256a at https://goerli.etherscan.io/address/0x0f779f0c7d0c8b9cD6e23e62D9aE51ED39aa256a
Rollover deployed to 0x17b9Ee3963a58c82d64Aa9fdaCce261257834623 at https://goerli.etherscan.io/address/0x17b9Ee3963a58c82d64Aa9fdaCce261257834623

May 24 '23
Goerli test of streamlined Withdrawals contract
/// @dev Test on goerli deployed at https://goerli.etherscan.io/address/0x4db116ad5cca33ba5d2956dba80d56f27b6b2455

# Quickstart and developer notes

- Following env best practices from https://github.com/paulrberg/solidity-template
- Pre-run checks:

```
npm i --force
yarn sol
```

- Deployments and hardhat
  Run anvil for local host deploy

```
anvil --fork-url https://mainnet.sharedtools.org/apecoinrpc
 npx hardhat run --network ...
```

```
export GOERLIPK='Goerli private key'
export ETHERSCAN_API='xx'
export ALCHEMY_GOERLI_KEY='xx'
// see deploy_minterv2.js or deploy tasks in package.json for hardhat deploy usage
```

# Archival

# Errors

A note on errors
To reduce bytecode size and gas costs, error strings are shortened following UNIv3 as an example.  
The template is: {origin contract}:reason  
Common reasons:

```
CBL0 - contract balance will be less than 0 after this operation
VL0 - Value less than or equal to 0 and needs to be greater than 0
VLC - Value less than cap or check amount
AGC - Amount greater than cap or some stored value or requirement
NA - No Access / Not allowed
AE - Already exists
0AD - 0 address
```

# SharedDeposit V2

Spec:

- TODO

# SharedDeposit V3

Spec:

- Use CLI options to set ETH1 exit as this upgradeable contract - contract needs to be upgradeable
- This allows trustless staking as ETH cannot to be taken by an admin
- Disable any future migrations or minting and control minting roles
- Build a large broader community multisig with partners and set it as owner of the contract
- Require a withdrawal queue to prevent bot arbitrage
- Create a oracle for single token value tracking for VETH2 price appreciation that can be updated with offchain calc on validators
- Bonus:
- Auto buy SGT from generated fees and send to master chef type contracts for rewards boost
- Require the user to have some SGT for solo staking or withdrawing VETH2 into ETH at a discounted market rate
- Allow the contract to be deployed via a factory allowing others to reuse the scaffolding to create their own ETH2 staking solutions i.e. staking server providers such as certus one
- Minting support to allow adding a new minter to support swapping a share token into a yield bearing sharing token controlled by the oracle module
  e.g. swapping veth2 to a yield bearing eth2 validator share derivative token
- Support for stable coins
- Address blocklist; currently deploying a new eth2 validator takes effort. one can assume exiting one would also take effort. a blocklist would prevent a malicious address from forcing continous entries and exits e.g. an address adding and exiting 1000s of eth every epoch. some parameters should be set to prevent user concers such as a final exit allowance

# Gas profiling

Gas profiling on goerli with different optimizations.  
Transfer costs:  
Optimizations | Cost
5000000 | 51481
200 | 51553

This represents a 0.13% improvement in the cost of a transfer, arguably the most frequent interaction.  
Deploy costs:  
Optimizations | Cost  
5000000 | 27645256739592190  
200 | 22124896691748864

This represents a 24% increase in deployment costs with 5000000 optimizer runs vs 200.

This was carried out on Goerli using a gas price avg of 4.5 Gwei.  
Based on this a 200 run base is chosen.

Gas costs of large lists in args:  
With around ~100 addresses in a constructor arg gas price of the entire deploy stack increased by around 10%.

Added gas observations - may '23

- OZ methods are not always optimal / most effecient. e.g. see address.sendValue vs examples from solidity docs to achieve same
- 30% call cost reduction for 2% more contract size
  Optimization increases deployment of withdrawals.sol by 10k gas units, but shows a call cost reduction of 3k / call or ~3% on empty loops i.e redeem without any staked collateral
- loading calldata into mem e.g. via `address usr = msg.sender;` vs loading directly from msg.sender where needed
- setting global vars to immutable

# Deploying gov v2 to prod

- First we build to lint everything and make sure everything is standard
- Then clean to prevent etherscan verify issues
- Then we run the deploy gov script which will deploy main contracts and allocate specific funding to them all. This script will also then run etherscan verify
- **Manual followups are needed**
- Create a Sushiswap LP position
- Create a vote escrow token for these lP positions using the vote escrow factory
- Add these LP tokens and vote escrow tokens to the masterchef contract
- Set burn address for the vote escrow contract to 0x..dead
- Make sure vote escrow contract works
- Make sure farming master chef contract works
- Burn initial LP tokens manually or via unicrypt

```
npm run-script deploy_gov_prod
```

# Extended Deploy logs Sep 1 2021

```
Deployed SGTv2 to 0x24C19F7101c1731b85F1127EaA0407732E36EcDD on mainnet

Deployed TokenMigrator to 0x9615460582Efa2a9b1d8D21e7E02afE43A415E13 on mainnet

Deployed VoteEscrowFactory to 0xeE5bd4b9C875BE3958b1255D181B8B3E978903b9 on mainnet

Deployed SimpleVesting to 0x0279eBC54179EBc5E5e65A9f036Db351233adDc6 on mainnet

Deployed SimpleVesting to 0x2Cb4bdc030975f2ABdbbb984e87715505C51D5BC on mainnet

Deployed SimpleTimelock to 0xC0AAB794F9D2aA7cE56B8BEB6cFfc71BC05c21FC on mainnet

Deployed FundDistributor to 0x38aa4CC003D9Ad84505bc7b096122402Db31f708 on mainnet
Initialized FundDistributor with 0x24C19F7101c1731b85F1127EaA0407732E36EcDD

Tokens transferred: From 0x24C19F7101c1731b85F1127EaA0407732E36EcDD to TokenMigrator at 0x9615460582Efa2a9b1d8D21e7E02afE43A415E13 : 3200000000000000000000000
Tokens transferred: From 0x24C19F7101c1731b85F1127EaA0407732E36EcDD to treasuryVesting at 0x2Cb4bdc030975f2ABdbbb984e87715505C51D5BC : 2380000000000000000000000
Tokens transferred: From 0x24C19F7101c1731b85F1127EaA0407732E36EcDD to founderVesting at 0x0279eBC54179EBc5E5e65A9f036Db351233adDc6 : 1020000000000000000000000
Tokens transferred: From 0x24C19F7101c1731b85F1127EaA0407732E36EcDD to FundDistributor at 0x38aa4CC003D9Ad84505bc7b096122402Db31f708 : 2040000000000000000000000
Tokens transferred: From 0x24C19F7101c1731b85F1127EaA0407732E36EcDD to SimpleTimelock at 0xC0AAB794F9D2aA7cE56B8BEB6cFfc71BC05c21FC : 1360000000000000000000000
Setup farming
Granting ACL rights to 0xcB9D78CB76a86844667eAF3Ac62CB5D377b3ce5C
Granting ACL rights to 0x610c92c70Eb55dFeAFe8970513D13771Da79f2e0
Granting ACL rights to 0xa1feaF41d843d53d0F6bEd86a8cF592cE21C409e
ACL Sentinels added
Ownership transferred for treasuryVesting at 0x2Cb4bdc030975f2ABdbbb984e87715505C51D5BC to 0xeBc37F4c20C7F8336E81fB3aDf82f6372BEf777E
Ownership transferred for SimpleTimelock at 0xC0AAB794F9D2aA7cE56B8BEB6cFfc71BC05c21FC to 0xeBc37F4c20C7F8336E81fB3aDf82f6372BEf777E
Ownership transferred for FundDistributor at 0x38aa4CC003D9Ad84505bc7b096122402Db31f708 to 0xeBc37F4c20C7F8336E81fB3aDf82f6372BEf777E
Ownership transferred for TokenMigrator at 0x9615460582Efa2a9b1d8D21e7E02afE43A415E13 to 0xeBc37F4c20C7F8336E81fB3aDf82f6372BEf777E
Ownership transferred for Blocklist at <redacted> to 0xeBc37F4c20C7F8336E81fB3aDf82f6372BEf777E
Ownership transferred for Allowlist at <redacted> to 0xeBc37F4c20C7F8336E81fB3aDf82f6372BEf777E
```
